<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Blake's Damage Report</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a12">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* ===== ANIMATIONS ===== */
@keyframes pulse-glow{0%{box-shadow:0 0 8px var(--accent)}50%{box-shadow:0 0 25px var(--accent),0 0 50px rgba(255,107,53,0.3)}100%{box-shadow:0 0 8px var(--accent)}}
@keyframes toast-in{0%{transform:translateX(100%);opacity:0}100%{transform:translateX(0);opacity:1}}
@keyframes toast-out{0%{transform:translateX(0);opacity:1}100%{transform:translateX(100%);opacity:0}}
@keyframes flash{0%{opacity:1}50%{opacity:0.3}100%{opacity:1}}
@keyframes beer-fall{0%{transform:translateY(-40px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(360deg);opacity:0}}
@keyframes confetti-fall{0%{transform:translateY(-10px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
@keyframes call911{0%,100%{background:#ff0000}50%{background:var(--bg)}}
@keyframes status-flash{0%,100%{opacity:1}50%{opacity:0.4}}
@keyframes btn-pulse{0%{transform:scale(1)}50%{transform:scale(1.12)}100%{transform:scale(1)}}
@keyframes fadeInUp{0%{opacity:0;transform:translateY(30px)}100%{opacity:1;transform:translateY(0)}}
@keyframes flicker{0%,100%{opacity:1}92%{opacity:1}93%{opacity:0.3}94%{opacity:1}97%{opacity:0.5}98%{opacity:1}}
@keyframes scanMove{0%{top:-50%}100%{top:100%}}
@keyframes glitchText{0%{text-shadow:0 0 20px var(--neon),0 0 60px var(--neon)}50%{text-shadow:0 0 40px var(--neon),0 0 80px var(--neon),3px 0 #f0f,-3px 0 #0ff}100%{text-shadow:0 0 20px var(--neon),0 0 60px var(--neon)}}
@keyframes cardStagger{0%{opacity:0;transform:translateY(40px) scale(0.9)}100%{opacity:1;transform:translateY(0) scale(1)}}
@keyframes selectFlash{0%{box-shadow:0 0 0 0 var(--beer-color)}50%{box-shadow:0 0 40px 10px var(--beer-color)}100%{box-shadow:0 0 60px 20px var(--beer-color)}}
@keyframes countPop{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}

/* FLAG + EAGLE ANIMATIONS */
@keyframes flag-appear{
  0%{opacity:0;transform:scale(0.3) rotate(-10deg)}
  15%{opacity:1;transform:scale(1.1) rotate(2deg)}
  25%{transform:scale(1) rotate(0deg)}
  70%{opacity:1}
  100%{opacity:0;transform:scale(1.05) rotate(0deg)}
}
@keyframes eagle-fly{
  0%{left:-20%;top:25%;transform:scaleX(-1) scale(1) rotate(0deg);opacity:1}
  25%{top:15%;transform:scaleX(-1) scale(1.5) rotate(-10deg);opacity:1}
  50%{top:30%;transform:scaleX(-1) scale(1.3) rotate(5deg);opacity:1}
  75%{top:18%;transform:scaleX(-1) scale(1.4) rotate(-5deg);opacity:1}
  100%{left:110%;top:25%;transform:scaleX(-1) scale(1) rotate(0deg);opacity:0}
}
@keyframes flag-wave{
  0%{transform:perspective(400px) rotateY(0deg)}
  25%{transform:perspective(400px) rotateY(5deg)}
  50%{transform:perspective(400px) rotateY(0deg)}
  75%{transform:perspective(400px) rotateY(-5deg)}
  100%{transform:perspective(400px) rotateY(0deg)}
}

/* ===== CSS VARIABLES ===== */
:root{
  --bg:#0a0a12;
  --bg-card:rgba(255,255,255,0.03);
  --bg-card-hover:rgba(255,255,255,0.06);
  --border:rgba(255,255,255,0.06);
  --border-hover:rgba(255,255,255,0.12);
  --text:#ffffff;
  --text-muted:#6b6b80;
  --text-dim:#3a3a4a;
  --accent:#ff6b35;
  --accent2:#ff3366;
  --gradient:linear-gradient(135deg,#ff6b35,#ff3366);
  --neon:#ff6b35;
  --radius:16px;
  --radius-sm:10px;
}

html{font-size:16px}
body{
  background:var(--bg);color:var(--text);
  font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  min-height:100vh;display:flex;justify-content:center;
  overflow-x:hidden;transition:background-color 0.8s ease;
  -webkit-font-smoothing:antialiased;
}

/* ===== WARRIOR OVERLAY ===== */
.warrior-overlay{
  position:fixed;inset:0;z-index:10000;
  background:#0a0a0f;
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;
  transition:opacity 0.4s ease,visibility 0.4s ease;
  overflow-y:auto;
}
.warrior-overlay.visible{opacity:1;visibility:visible}
.warrior-overlay.closing{opacity:0;transform:scale(1.05);transition:all 0.5s ease}

/* CRT scanlines */
.warrior-overlay::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:1;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.08) 2px,rgba(0,0,0,0.08) 4px);
}
/* Moving scan line */
.warrior-overlay::before{
  content:'';position:fixed;left:0;right:0;height:80px;z-index:2;
  background:linear-gradient(180deg,transparent,rgba(255,107,53,0.03),transparent);
  animation:scanMove 4s linear infinite;pointer-events:none;
}

.warrior-content{
  width:100%;max-width:420px;padding:40px 20px;position:relative;z-index:3;
  text-align:center;
}
.warrior-back{
  position:absolute;top:16px;right:16px;
  background:none;border:1px solid rgba(255,255,255,0.15);
  color:#888;font-size:0.75rem;padding:6px 14px;border-radius:20px;
  cursor:pointer;font-family:'Inter',sans-serif;z-index:4;
  transition:all 0.2s;
}
.warrior-back:hover{color:#fff;border-color:rgba(255,255,255,0.4)}
.warrior-pretitle{
  font-family:'Press Start 2P',monospace;font-size:0.55rem;
  color:var(--accent);letter-spacing:3px;margin-bottom:16px;
  animation:flicker 3s infinite;
}
.warrior-title{
  font-family:'Press Start 2P',monospace;font-size:1.1rem;
  color:#fff;line-height:1.6;margin-bottom:8px;
  text-shadow:0 0 20px var(--neon),0 0 60px rgba(255,107,53,0.4);
  animation:glitchText 4s ease infinite;
}
.warrior-subtitle{
  font-size:0.8rem;color:var(--text-muted);margin-bottom:32px;
  font-weight:400;
}
.warrior-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:12px;
  margin-bottom:24px;
}
.warrior-card{
  --beer-color:#ff6b35;
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;padding:20px 10px 16px;
  cursor:pointer;transition:all 0.3s ease;
  position:relative;overflow:hidden;
  animation:cardStagger 0.5s ease both;
}
.warrior-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:var(--beer-color);opacity:0;transition:opacity 0.3s;
}
.warrior-card:hover{
  border-color:var(--beer-color);
  background:rgba(255,255,255,0.06);
  transform:translateY(-2px);
  box-shadow:0 8px 30px rgba(0,0,0,0.4),0 0 20px color-mix(in srgb,var(--beer-color) 20%,transparent);
}
.warrior-card:hover::before{opacity:1}
.warrior-card:active{transform:scale(0.97)}
.warrior-card.selected{
  border-color:var(--beer-color);
  animation:selectFlash 0.6s ease forwards;
}
.warrior-emoji{font-size:2rem;margin-bottom:8px}
.warrior-name{font-weight:700;font-size:0.8rem;color:#fff;margin-bottom:4px}
.warrior-tagline{font-size:0.65rem;color:var(--text-muted);font-style:italic}
.warrior-flash{
  position:fixed;inset:0;z-index:9999;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.85);opacity:0;
  transition:opacity 0.2s;pointer-events:none;
}
.warrior-flash.visible{opacity:1}
.warrior-flash-text{
  font-family:'Press Start 2P',monospace;font-size:1.4rem;
  color:#fff;text-shadow:0 0 30px var(--neon),0 0 60px var(--neon);
}

/* ===== MAIN APP ===== */
#app{
  width:100%;max-width:440px;padding:20px 20px 100px;
  transform-origin:center top;
}

/* HERO */
.hero{text-align:center;padding:24px 0 8px}
.title{
  font-size:1.5rem;font-weight:900;text-transform:uppercase;
  letter-spacing:1px;line-height:1.2;
  background:var(--gradient);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.subtitle{
  font-size:0.65rem;color:var(--text-muted);letter-spacing:5px;
  text-transform:uppercase;margin-top:6px;font-weight:600;
}

/* TIMER */
.timer-section{text-align:center;padding:28px 0 8px}
.timer-display{
  font-size:4rem;font-weight:900;letter-spacing:2px;
  color:#fff;line-height:1;margin-bottom:6px;
  font-variant-numeric:tabular-nums;
  transition:filter 0.5s ease;
}
.selected-beer-display{
  font-size:0.75rem;color:var(--text-muted);margin-bottom:16px;
  font-weight:600;letter-spacing:1px;min-height:20px;
}
.selected-beer-display span{
  background:var(--gradient);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;font-weight:700;
}
.timer-btn{
  background:var(--gradient);color:#fff;border:none;
  font-size:0.9rem;font-weight:700;text-transform:uppercase;
  padding:14px 44px;cursor:pointer;letter-spacing:2px;
  font-family:'Inter',sans-serif;border-radius:50px;
  transition:all 0.3s;position:relative;overflow:hidden;
  box-shadow:0 4px 20px rgba(255,107,53,0.3);
}
.timer-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 6px 30px rgba(255,107,53,0.4);
}
.timer-btn:active{transform:scale(0.97)}
.timer-btn.stop{
  background:transparent;
  border:2px solid rgba(255,107,53,0.4);
  box-shadow:none;
}
.timer-btn.stop:hover{
  border-color:var(--accent);
  box-shadow:0 4px 20px rgba(255,107,53,0.2);
}

/* STATUS BADGE */
.status-section{text-align:center;padding:16px 0}
.status-badge{
  display:inline-block;padding:8px 24px;border-radius:50px;
  font-size:0.7rem;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;transition:all 0.5s ease;
  border:1px solid;
  background:rgba(255,255,255,0.03);
}

/* BEER COUNTER */
.beer-section{
  text-align:center;padding:24px 0;
  background:var(--bg-card);border-radius:var(--radius);
  border:1px solid var(--border);margin:8px 0;
}
.beer-label{
  font-size:0.6rem;color:var(--text-muted);letter-spacing:4px;
  text-transform:uppercase;margin-bottom:16px;font-weight:700;
}
.beer-controls{display:flex;align-items:center;justify-content:center;gap:24px}
.beer-btn{
  width:56px;height:56px;border-radius:50%;
  border:2px solid rgba(255,107,53,0.3);
  background:rgba(255,107,53,0.06);color:var(--accent);
  font-size:1.6rem;font-weight:700;cursor:pointer;
  font-family:'Inter',sans-serif;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.3s;line-height:1;
}
.beer-btn:hover{
  background:rgba(255,107,53,0.15);border-color:var(--accent);
  box-shadow:0 0 20px rgba(255,107,53,0.2);
}
.beer-btn:active{transform:scale(0.92)}
.beer-btn:disabled{opacity:0.2;cursor:not-allowed;box-shadow:none}
.beer-btn.plus-pulse{animation:btn-pulse 0.3s ease,pulse-glow 0.6s ease}
.beer-count-wrap{min-width:100px;text-align:center}
.beer-count{
  font-size:5rem;font-weight:900;line-height:1;
  background:var(--gradient);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  transition:transform 0.2s;
}
.beer-count.pop{animation:countPop 0.25s ease}
.beer-emoji{font-size:0.85rem;color:var(--text-dim);margin-top:6px;letter-spacing:2px}

/* SECTION HEADERS */
.section-header{
  font-size:0.6rem;color:var(--text-muted);letter-spacing:4px;
  text-transform:uppercase;font-weight:700;
  padding:28px 0 14px;
}

/* ===== METRIC TABS ===== */
.metric-tab{
  margin:8px 0;
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
  transition:border-color 0.3s;
}
.metric-tab:hover{border-color:var(--border-hover)}
.metric-tab-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;
  background:var(--bg-card);
  cursor:pointer;
  font-size:0.65rem;font-weight:700;
  color:var(--text-muted);
  letter-spacing:3px;text-transform:uppercase;
  transition:all 0.3s;user-select:none;
}
.metric-tab-header:hover{color:var(--text);background:var(--bg-card-hover)}
.metric-tab-header:active{transform:scale(0.99)}
.tab-header-left{display:flex;align-items:center;gap:10px}
.tab-icon{font-size:1rem;-webkit-text-fill-color:initial}
.tab-arrow{
  transition:transform 0.3s ease;font-size:0.8rem;
  color:var(--text-dim);
}
.metric-tab.open .tab-arrow{transform:rotate(90deg);color:var(--accent)}
.metric-tab-content{
  max-height:0;overflow:hidden;
  transition:max-height 0.4s ease,padding 0.4s ease;
  padding:0 16px;
  background:rgba(255,255,255,0.01);
}
.metric-tab.open .metric-tab-content{
  max-height:500px;padding:16px;
}
.metric-tab.open{border-color:rgba(255,107,53,0.15)}

/* STATS */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-card{
  background:var(--bg-card);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px 12px;text-align:center;
  transition:all 0.3s;
}
.stat-card:hover{border-color:var(--border-hover);background:var(--bg-card-hover)}
.stat-value{
  font-size:1.5rem;font-weight:900;
  background:var(--gradient);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.stat-label{
  font-size:0.55rem;color:var(--text-muted);letter-spacing:2px;
  text-transform:uppercase;margin-top:6px;font-weight:600;
}
.stat-value.small-text{font-size:0.9rem}

/* ACHIEVEMENTS */
.achievements-list{display:flex;flex-wrap:wrap;gap:8px}
.ach-badge{
  padding:6px 14px;border:1px solid var(--border);
  font-size:0.65rem;font-weight:600;
  background:var(--bg-card);color:var(--text-muted);border-radius:50px;
  transition:all 0.3s;
}
.ach-badge.unlocked{
  border-color:rgba(255,107,53,0.4);color:var(--accent);
  background:rgba(255,107,53,0.08);
}

/* HISTORY */
.history-list{display:flex;flex-direction:column;gap:10px;max-height:400px;overflow-y:auto}
.history-list::-webkit-scrollbar{width:4px}
.history-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:4px}
.history-card{
  border:1px solid var(--border);border-radius:var(--radius);
  padding:16px;background:var(--bg-card);
  display:grid;grid-template-columns:1fr 1fr;gap:6px;
  transition:all 0.3s;
}
.history-card:hover{border-color:var(--border-hover);background:var(--bg-card-hover)}
.history-card .hc-date{
  grid-column:1/-1;font-size:0.6rem;color:var(--text-muted);
  letter-spacing:1px;font-weight:600;margin-bottom:4px;
}
.history-card .hc-beer-type{
  grid-column:1/-1;font-size:0.6rem;color:var(--accent);
  font-weight:600;margin-bottom:2px;
}
.history-card .hc-val{font-size:1rem;font-weight:800}
.history-card .hc-lbl{font-size:0.5rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.history-card .hc-score{
  background:var(--gradient);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}

/* TOAST */
.toast-container{
  position:fixed;top:16px;right:16px;
  width:85%;max-width:340px;z-index:9999;
  display:flex;flex-direction:column;gap:8px;
  pointer-events:none;
}
.toast{
  background:var(--bg);
  border:1px solid rgba(255,107,53,0.3);
  border-left:3px solid var(--accent);
  color:#fff;padding:14px 18px;border-radius:var(--radius-sm);
  font-weight:600;font-size:0.8rem;
  font-family:'Inter',sans-serif;
  animation:toast-in 0.3s ease forwards;
  pointer-events:auto;backdrop-filter:blur(20px);
  box-shadow:0 8px 30px rgba(0,0,0,0.4);
}
.toast.removing{animation:toast-out 0.3s ease forwards}

/* BEER RAIN */
.beer-rain{
  position:fixed;pointer-events:none;font-size:1.8rem;
  animation:beer-fall 1.8s ease-in forwards;z-index:100;
}

/* CONFETTI */
.confetti-particle{
  position:fixed;width:8px;height:8px;pointer-events:none;
  animation:confetti-fall 2s ease-in forwards;z-index:100;
}

/* EMPTY STATE */
.empty-state{
  color:var(--text-dim);font-size:0.75rem;text-align:center;
  padding:30px 20px;letter-spacing:1px;
}

/* CALL 911 MODE - plays only twice (1 second total) */
body.call911{animation:call911 0.5s ease 2 forwards}

/* ===== FLAG OVERLAY ===== */
.flag-overlay{
  position:fixed;inset:0;z-index:8000;
  pointer-events:none;opacity:0;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.4);
}
.flag-overlay.active{
  animation:flag-appear 2.5s ease forwards;
}
.flag-container{
  width:80vw;max-width:500px;
  aspect-ratio:19/10;position:relative;
  overflow:hidden;border-radius:4px;
  box-shadow:0 0 80px rgba(255,0,0,0.4),0 0 120px rgba(0,0,180,0.3),0 0 200px rgba(255,255,255,0.1);
  animation:flag-wave 0.6s ease infinite;
}
.flag-stripes{
  width:100%;height:100%;
  background:repeating-linear-gradient(
    to bottom,
    #B22234 0%,#B22234 7.69%,
    #fff 7.69%,#fff 15.38%
  );
}
.flag-canton{
  position:absolute;top:0;left:0;
  width:40%;height:53.85%;
  background:#3C3B6E;
  display:grid;
  grid-template-columns:repeat(6,1fr);
  grid-template-rows:repeat(5,1fr);
  align-items:center;justify-items:center;
  padding:2px;
}
.flag-star{
  color:#fff;font-size:0.6rem;line-height:1;
  text-shadow:0 0 4px rgba(255,255,255,0.8);
}
.flag-text{
  position:absolute;bottom:-40px;left:0;right:0;
  text-align:center;
  font-family:'Press Start 2P',monospace;
  font-size:0.9rem;color:#fff;
  text-shadow:0 0 20px rgba(255,0,0,0.8),0 0 40px rgba(0,0,255,0.6);
  letter-spacing:4px;
}

/* ===== EAGLE FLY ===== */
.eagle-fly{
  position:fixed;z-index:8500;
  font-size:5rem;pointer-events:none;
  top:25%;left:-20%;opacity:0;
  filter:drop-shadow(0 0 30px rgba(255,215,0,0.6)) drop-shadow(0 0 60px rgba(255,107,53,0.3));
}
.eagle-fly.active{
  animation:eagle-fly 2s ease-in-out forwards;
}

/* FOOTER */
.footer{
  text-align:center;padding:40px 0 20px;
  color:var(--text-dim);font-size:0.6rem;letter-spacing:2px;font-weight:600;
}
</style>
</head>
<body>

<!-- ===== WARRIOR SELECT OVERLAY ===== -->
<div id="warriorOverlay" class="warrior-overlay">
  <button class="warrior-back" onclick="hideWarriorSelect()">&#x2715; Back</button>
  <div class="warrior-content">
    <div class="warrior-pretitle">&#9612; INSERT COIN &#9616;</div>
    <div class="warrior-title">PICK YOUR<br>WARRIOR</div>
    <div class="warrior-subtitle">Choose your weapon for tonight</div>
    <div class="warrior-grid" id="warriorGrid"></div>
  </div>
</div>

<!-- ===== FLASH TEXT ===== -->
<div class="warrior-flash" id="warriorFlash">
  <div class="warrior-flash-text">LET'S GO!</div>
</div>

<!-- ===== FLAG + EAGLE OVERLAY ===== -->
<div class="flag-overlay" id="flagOverlay">
  <div class="flag-container">
    <div class="flag-stripes"></div>
    <div class="flag-canton" id="flagCanton"></div>
    <div class="flag-text">U S A</div>
  </div>
</div>
<div class="eagle-fly" id="eagleFly">&#x1F985;</div>

<!-- ===== MAIN DASHBOARD ===== -->
<div id="app">
  <div class="hero">
    <div class="title">Blake's Damage Report</div>
    <div class="subtitle">Session Tracker</div>
  </div>

  <div class="timer-section">
    <div class="timer-display" id="timerDisplay">00:00:00</div>
    <div class="selected-beer-display" id="selectedBeerDisplay"></div>
    <button class="timer-btn" id="timerBtn" onclick="toggleSession()">Start Session</button>
  </div>

  <div class="status-section">
    <span class="status-badge" id="statusBadge">Sober &amp; Curious</span>
  </div>

  <div class="beer-section">
    <div class="beer-label">Beers Consumed</div>
    <div class="beer-controls">
      <button class="beer-btn" id="minusBtn" onclick="changeBeer(-1)" disabled>&#8722;</button>
      <div class="beer-count-wrap">
        <div class="beer-count" id="beerCount">0</div>
        <div class="beer-emoji" id="beerEmoji"></div>
      </div>
      <button class="beer-btn" id="plusBtn" onclick="changeBeer(1)">+</button>
    </div>
  </div>

  <!-- SESSION METRICS TAB -->
  <div class="metric-tab" id="sessionTab">
    <div class="metric-tab-header" onclick="toggleMetricTab('sessionTab')">
      <div class="tab-header-left">
        <span class="tab-icon">&#x1F4CA;</span>
        <span>Session Metrics</span>
      </div>
      <span class="tab-arrow">&#x25B8;</span>
    </div>
    <div class="metric-tab-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="sessDuration">--:--:--</div><div class="stat-label">Duration</div></div>
        <div class="stat-card"><div class="stat-value" id="sessBeers">0</div><div class="stat-label">Beers</div></div>
        <div class="stat-card"><div class="stat-value" id="sessRate">0.0</div><div class="stat-label">Beers / Hr</div></div>
        <div class="stat-card"><div class="stat-value" id="sessStatus">--</div><div class="stat-label">Status</div></div>
        <div class="stat-card" style="grid-column:1/-1"><div class="stat-value small-text" id="sessBeerType">--</div><div class="stat-label">Warrior</div></div>
      </div>
    </div>
  </div>

  <!-- LIFETIME METRICS TAB -->
  <div class="metric-tab" id="lifetimeTab">
    <div class="metric-tab-header" onclick="toggleMetricTab('lifetimeTab')">
      <div class="tab-header-left">
        <span class="tab-icon">&#x1F3C6;</span>
        <span>Lifetime Metrics</span>
      </div>
      <span class="tab-arrow">&#x25B8;</span>
    </div>
    <div class="metric-tab-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="ltSessions">0</div><div class="stat-label">Sessions</div></div>
        <div class="stat-card"><div class="stat-value" id="ltHours">0</div><div class="stat-label">Total Hours</div></div>
        <div class="stat-card"><div class="stat-value" id="ltBeers">0</div><div class="stat-label">Total Beers</div></div>
        <div class="stat-card"><div class="stat-value" id="ltAvg">0.0</div><div class="stat-label">Avg Beers/Hr</div></div>
        <div class="stat-card"><div class="stat-value" id="ltRecord">0</div><div class="stat-label">Record Beers</div></div>
        <div class="stat-card"><div class="stat-value small-text" id="ltFavBeer">--</div><div class="stat-label">Fav Warrior</div></div>
      </div>
    </div>
  </div>

  <div class="section-header">Achievements</div>
  <div class="achievements-list" id="achievementsList"></div>

  <div class="section-header">Session History</div>
  <div class="history-list" id="historyList">
    <div class="empty-state">No sessions yet. Start one above.</div>
  </div>

  <div class="footer">Built for Blake. God help us all.</div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ========== BEER OPTIONS ==========
const BEER_OPTIONS = [
  { id:'miller-lite', name:'Miller Lite', tagline:'The Lightweight', emoji:'\u{1F37A}', color:'#f5d442' },
  { id:'summer-shandy', name:'Summer Shandy', tagline:'The Pool Boy', emoji:'\u2600\uFE0F', color:'#ffb347' },
  { id:'guinness', name:'Guinness', tagline:'The Dark Knight', emoji:'\u{1F3B1}', color:'#c0392b' },
  { id:'coors-light', name:'Coors Light', tagline:'The Silver Bullet', emoji:'\u{1F3D4}\uFE0F', color:'#a8b8c8' },
  { id:'blue-moon', name:'Blue Moon', tagline:'The Fancy One', emoji:'\u{1F319}', color:'#4a90d9' },
  { id:'corona', name:'Corona', tagline:'The Vacationer', emoji:'\u{1F3D6}\uFE0F', color:'#ffd700' },
  { id:'bud-light', name:'Bud Light', tagline:"The People's Champ", emoji:'\u{1F3C6}', color:'#1e90ff' },
  { id:'modelo', name:'Modelo', tagline:'The Fighter', emoji:'\u{1F94A}', color:'#d4a017' },
];

// ========== STATE ==========
let sessionActive = false;
let sessionStart = null;
let beers = 0;
let selectedBeer = null;
let shakeIntensity = 3;
let shakeTimer = null;
let timerInterval = null;
let tickInterval = null;
let statusInterval = null;
let call911Timeout = null;
let audioCtx = null;
let flagAnimating = false;

const ACHIEVEMENTS = [
  { id:'first_blood', name:'First Blood', icon:'\u{1F37A}', desc:'1 beer consumed' },
  { id:'founding_father', name:'Founding Father', icon:'\u{1F1FA}\u{1F1F8}', desc:'5 beers consumed' },
  { id:'full_patriot', name:'Full Patriot', icon:'\u{1F985}', desc:'10 beers consumed' },
  { id:'rabbit_hole', name:'Down the Rabbit Hole', icon:'\u23F1\uFE0F', desc:'2 hours watched' },
  { id:'no_life', name:'No Life', icon:'\u{1F319}', desc:'4 hours watched' },
  { id:'efficiency', name:'Efficiency Expert', icon:'\u{1F4CA}', desc:'5+ beers/hr' },
  { id:'personal_record', name:'Personal Record', icon:'\u{1F3C6}', desc:'Beat previous best' },
];

// ========== AUDIO ==========
function getAudioCtx(){
  if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended') audioCtx.resume();
  return audioCtx;
}

function playGuitarRiff(){
  const ctx=getAudioCtx();
  const t=ctx.currentTime;

  // Create distortion curve for that crunchy guitar tone
  const distortion=ctx.createWaveShaper();
  const samples=44100;
  const curve=new Float32Array(samples);
  for(let i=0;i<samples;i++){
    const x=(i*2)/samples-1;
    curve[i]=(Math.PI+40)*x/(Math.PI+40*Math.abs(x));
  }
  distortion.curve=curve;
  distortion.oversample='4x';

  // Master gain
  const masterGain=ctx.createGain();
  masterGain.gain.setValueAtTime(0.12,t);
  distortion.connect(masterGain);
  masterGain.connect(ctx.destination);

  // Power chord riff: E5 -> A5 -> B5 -> E5 high -> final chug
  const chords=[
    {notes:[82.41,123.47,164.81],time:0,dur:0.35},
    {notes:[110,164.81,220],time:0.35,dur:0.3},
    {notes:[123.47,185,246.94],time:0.65,dur:0.25},
    {notes:[164.81,246.94,329.63],time:0.9,dur:0.4},
    {notes:[164.81,246.94,329.63,659.25],time:1.3,dur:0.7},
  ];

  chords.forEach(chord=>{
    chord.notes.forEach(freq=>{
      const osc=ctx.createOscillator();
      const gain=ctx.createGain();
      osc.connect(gain);gain.connect(distortion);
      osc.type='sawtooth';
      osc.frequency.setValueAtTime(freq,t+chord.time);
      gain.gain.setValueAtTime(0.0001,t);
      gain.gain.linearRampToValueAtTime(0.25,t+chord.time+0.01);
      gain.gain.setValueAtTime(0.2,t+chord.time+chord.dur*0.7);
      gain.gain.exponentialRampToValueAtTime(0.001,t+chord.time+chord.dur);
      osc.start(t+chord.time);osc.stop(t+chord.time+chord.dur+0.05);
    });
  });

  // Add some palm-mute percussive hits
  [0,0.35,0.65].forEach(time=>{
    const buf=ctx.createBuffer(1,ctx.sampleRate*0.05,ctx.sampleRate);
    const data=buf.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.5;
    const noise=ctx.createBufferSource();
    const nGain=ctx.createGain();
    noise.buffer=buf;noise.connect(nGain);nGain.connect(ctx.destination);
    nGain.gain.setValueAtTime(0.06,t+time);
    nGain.gain.exponentialRampToValueAtTime(0.001,t+time+0.04);
    noise.start(t+time);
  });
}

function playEagleScreech(){
  const ctx=getAudioCtx();
  const t=ctx.currentTime;

  // Main screech - high pitched with warble
  const osc1=ctx.createOscillator();const gain1=ctx.createGain();
  osc1.connect(gain1);gain1.connect(ctx.destination);
  osc1.type='sawtooth';
  osc1.frequency.setValueAtTime(3500,t);
  osc1.frequency.exponentialRampToValueAtTime(2200,t+0.12);
  osc1.frequency.exponentialRampToValueAtTime(3200,t+0.25);
  osc1.frequency.exponentialRampToValueAtTime(2800,t+0.4);
  osc1.frequency.exponentialRampToValueAtTime(900,t+0.8);
  gain1.gain.setValueAtTime(0.18,t);
  gain1.gain.setValueAtTime(0.15,t+0.4);
  gain1.gain.exponentialRampToValueAtTime(0.001,t+0.9);
  osc1.start(t);osc1.stop(t+0.9);

  // Secondary harmonic for richness
  const osc2=ctx.createOscillator();const gain2=ctx.createGain();
  osc2.connect(gain2);gain2.connect(ctx.destination);
  osc2.type='triangle';
  osc2.frequency.setValueAtTime(4200,t);
  osc2.frequency.exponentialRampToValueAtTime(1200,t+0.7);
  gain2.gain.setValueAtTime(0.08,t);
  gain2.gain.exponentialRampToValueAtTime(0.001,t+0.7);
  osc2.start(t);osc2.stop(t+0.7);

  // Noise texture
  const buf=ctx.createBuffer(1,ctx.sampleRate*0.3,ctx.sampleRate);
  const data=buf.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.3;
  const noise=ctx.createBufferSource();const nGain=ctx.createGain();
  noise.buffer=buf;noise.connect(nGain);nGain.connect(ctx.destination);
  nGain.gain.setValueAtTime(0.08,t);
  nGain.gain.exponentialRampToValueAtTime(0.001,t+0.3);
  noise.start(t);
}

function playSadBell(){
  const ctx=getAudioCtx();
  const osc=ctx.createOscillator();const gain=ctx.createGain();
  osc.connect(gain);gain.connect(ctx.destination);
  osc.type='sine';
  osc.frequency.setValueAtTime(220,ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(160,ctx.currentTime+0.8);
  gain.gain.setValueAtTime(0.12,ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.8);
  osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.8);
}

function playAirHorn(){
  const ctx=getAudioCtx();
  [440,554,659].forEach(f=>{
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='square';osc.frequency.setValueAtTime(f,ctx.currentTime);
    gain.gain.setValueAtTime(0.08,ctx.currentTime);
    gain.gain.setValueAtTime(0.08,ctx.currentTime+0.6);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.8);
    osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.8);
  });
}

function playSadTrombone(){
  const ctx=getAudioCtx();
  [392,370,349,311].forEach((f,i)=>{
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='sawtooth';
    osc.frequency.setValueAtTime(f,ctx.currentTime+i*0.35);
    gain.gain.setValueAtTime(0.0001,ctx.currentTime);
    gain.gain.setValueAtTime(0.1,ctx.currentTime+i*0.35);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.35+0.33);
    osc.start(ctx.currentTime+i*0.35);osc.stop(ctx.currentTime+i*0.35+0.35);
  });
}

function playUSAChant(){
  const ctx=getAudioCtx();
  [0,0.2,0.4,0.8,1.0,1.2].forEach(t=>{
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='square';osc.frequency.setValueAtTime(330,ctx.currentTime+t);
    gain.gain.setValueAtTime(0.0001,ctx.currentTime);
    gain.gain.setValueAtTime(0.1,ctx.currentTime+t);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.12);
    osc.start(ctx.currentTime+t);osc.stop(ctx.currentTime+t+0.15);
  });
}

function playBigAirHorn(){
  const ctx=getAudioCtx();
  [440,554,659,880].forEach(f=>{
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='square';osc.frequency.setValueAtTime(f,ctx.currentTime);
    gain.gain.setValueAtTime(0.1,ctx.currentTime);
    gain.gain.setValueAtTime(0.1,ctx.currentTime+1.0);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+1.3);
    osc.start(ctx.currentTime);osc.stop(ctx.currentTime+1.3);
  });
}

function playFanfare(){
  const ctx=getAudioCtx();
  [523,659,784].forEach((f,i)=>{
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='triangle';
    osc.frequency.setValueAtTime(f,ctx.currentTime+i*0.15);
    gain.gain.setValueAtTime(0.0001,ctx.currentTime);
    gain.gain.setValueAtTime(0.12,ctx.currentTime+i*0.15);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.15+0.3);
    osc.start(ctx.currentTime+i*0.15);osc.stop(ctx.currentTime+i*0.15+0.35);
  });
}

function playTick(){
  const ctx=getAudioCtx();
  const osc=ctx.createOscillator();const gain=ctx.createGain();
  osc.connect(gain);gain.connect(ctx.destination);
  osc.type='sine';osc.frequency.setValueAtTime(800,ctx.currentTime);
  gain.gain.setValueAtTime(0.015,ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.03);
  osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.03);
}

function playArcadeSelect(){
  const ctx=getAudioCtx();
  const osc=ctx.createOscillator();const gain=ctx.createGain();
  osc.connect(gain);gain.connect(ctx.destination);
  osc.type='square';
  osc.frequency.setValueAtTime(200,ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(600,ctx.currentTime+0.08);
  osc.frequency.exponentialRampToValueAtTime(800,ctx.currentTime+0.15);
  gain.gain.setValueAtTime(0.1,ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.2);
  osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.2);
}

function playArcadeConfirm(){
  const ctx=getAudioCtx();
  [523,659,784,1047].forEach((f,i)=>{
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='square';
    osc.frequency.setValueAtTime(f,ctx.currentTime+i*0.08);
    gain.gain.setValueAtTime(0.0001,ctx.currentTime);
    gain.gain.setValueAtTime(0.1,ctx.currentTime+i*0.08);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.08+0.12);
    osc.start(ctx.currentTime+i*0.08);osc.stop(ctx.currentTime+i*0.08+0.15);
  });
}

// ========== FLAG + EAGLE ANIMATION ==========
function buildFlagStars(){
  const canton=document.getElementById('flagCanton');
  // 30 stars in a simplified grid
  let stars='';
  for(let i=0;i<30;i++) stars+='<div class="flag-star">\u2605</div>';
  canton.innerHTML=stars;
}

function triggerFlagEagle(){
  if(flagAnimating) return;
  flagAnimating=true;

  const flag=document.getElementById('flagOverlay');
  const eagle=document.getElementById('eagleFly');

  // Reset animations
  flag.classList.remove('active');
  eagle.classList.remove('active');
  void flag.offsetWidth;
  void eagle.offsetWidth;

  // Start flag
  flag.classList.add('active');

  // Eagle starts slightly after flag appears
  setTimeout(()=>{
    eagle.classList.add('active');
    playEagleScreech();
  },300);

  // Clean up after animations finish
  setTimeout(()=>{
    flag.classList.remove('active');
    eagle.classList.remove('active');
    flagAnimating=false;
  },2600);
}

// ========== VISUALS ==========
function spawnBeerRain(){
  for(let i=0;i<8;i++){
    const el=document.createElement('div');
    el.className='beer-rain';el.textContent='\u{1F37A}';
    el.style.left=(Math.random()*90+5)+'%';
    el.style.top='-40px';
    el.style.animationDuration=(1.2+Math.random()*1.2)+'s';
    el.style.animationDelay=(Math.random()*0.3)+'s';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),3000);
  }
}

function spawnConfetti(){
  const colors=['#ff6b35','#ff3366','#ffd700','#4a90d9','#00ff88','#fff','#ff0000'];
  for(let i=0;i<40;i++){
    const el=document.createElement('div');
    el.className='confetti-particle';
    el.style.left=(Math.random()*100)+'%';
    el.style.top='-10px';
    el.style.background=colors[Math.floor(Math.random()*colors.length)];
    el.style.width=(4+Math.random()*8)+'px';
    el.style.height=(4+Math.random()*8)+'px';
    el.style.borderRadius=Math.random()>0.5?'50%':'2px';
    el.style.animationDuration=(1.5+Math.random()*1.5)+'s';
    el.style.animationDelay=(Math.random()*0.5)+'s';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),4000);
  }
}

function screenShake(){
  const app=document.getElementById('app');
  const intensity=shakeIntensity;
  const startTime=Date.now();
  const duration=1000;

  if(shakeTimer){cancelAnimationFrame(shakeTimer);shakeTimer=null;}

  function shakeFrame(){
    const elapsed=Date.now()-startTime;
    if(elapsed>=duration){
      shakeTimer=null;
      updateDrunkEffects();
      return;
    }
    const x=(Math.random()*2-1)*intensity;
    const y=(Math.random()*2-1)*intensity*0.5;
    const r=(Math.random()*2-1)*intensity*0.12;
    app.style.transform='translate('+x.toFixed(1)+'px,'+y.toFixed(1)+'px) rotate('+r.toFixed(2)+'deg)';
    shakeTimer=requestAnimationFrame(shakeFrame);
  }

  shakeFrame();
  shakeIntensity=Math.min(Math.round(shakeIntensity*1.5),50);
}

function screenFlash(){
  document.body.style.transition='background 0.1s';
  const orig=document.body.style.backgroundColor;
  document.body.style.backgroundColor='#fff';
  setTimeout(()=>{document.body.style.backgroundColor=orig;document.body.style.transition='background-color 0.8s ease';},100);
}

function updateDrunkEffects(){
  const app=document.getElementById('app');
  const timer=document.getElementById('timerDisplay');
  if(!shakeTimer){
    const maxTilt=8;
    const tiltDeg=Math.min(beers/12,1)*maxTilt*(Math.random()>0.5?1:-1);
    app.style.transform=beers>0?'rotate('+tiltDeg.toFixed(2)+'deg)':'';
  }
  const blur=Math.min(beers*0.3,4);
  timer.style.filter=blur>0?'blur('+blur.toFixed(1)+'px)':'none';
  const hrs=getElapsedHours();
  const bph=hrs>0?beers/hrs:0;
  if(bph<=0.5){document.body.style.backgroundColor='var(--bg)';}
  else if(bph<=2){const t=(bph-0.5)/1.5;document.body.style.backgroundColor=lerpColor('#0a0a12','#2a1500',t);}
  else if(bph<=4){const t=(bph-2)/2;document.body.style.backgroundColor=lerpColor('#2a1500','#3a0a00',t);}
  else{const t=Math.min((bph-4)/3,1);document.body.style.backgroundColor=lerpColor('#3a0a00','#500000',t);}
  const emojiEl=document.getElementById('beerEmoji');
  emojiEl.textContent='\u{1F37A}'.repeat(Math.min(beers,15));
}

function lerpColor(a,b,t){
  const ar=parseInt(a.slice(1,3),16),ag=parseInt(a.slice(3,5),16),ab=parseInt(a.slice(5,7),16);
  const br=parseInt(b.slice(1,3),16),bg=parseInt(b.slice(3,5),16),bb=parseInt(b.slice(5,7),16);
  return '#'+[Math.round(ar+(br-ar)*t),Math.round(ag+(bg-ag)*t),Math.round(ab+(bb-ab)*t)].map(c=>c.toString(16).padStart(2,'0')).join('');
}

// ========== METRIC TABS ==========
function toggleMetricTab(tabId){
  const tab=document.getElementById(tabId);
  tab.classList.toggle('open');
}

function updateSessionMetrics(){
  if(!sessionActive){
    document.getElementById('sessDuration').textContent='--:--:--';
    document.getElementById('sessBeers').textContent='0';
    document.getElementById('sessRate').textContent='--';
    document.getElementById('sessStatus').textContent='--';
    document.getElementById('sessBeerType').textContent='--';
    return;
  }
  const elapsed=getElapsedMs();
  const hrs=elapsed/3600000;
  const rate=hrs>0?(beers/hrs).toFixed(1):'0.0';
  document.getElementById('sessDuration').textContent=formatTime(elapsed);
  document.getElementById('sessBeers').textContent=beers;
  document.getElementById('sessRate').textContent=rate;
  document.getElementById('sessBeerType').textContent=selectedBeer?selectedBeer.emoji+' '+selectedBeer.name:'--';

  const bph=hrs>0?beers/hrs:(beers>0?beers*60:0);
  let status='Sober';
  if(bph>=6) status='CALL 911';
  else if(bph>=4) status='Send Help';
  else if(bph>=2) status='Full Send';
  else if(bph>=1) status='Patriotic';
  document.getElementById('sessStatus').textContent=status;
}

// ========== WARRIOR SELECT ==========
function renderWarriorGrid(){
  const grid=document.getElementById('warriorGrid');
  grid.innerHTML=BEER_OPTIONS.map((beer,i)=>
    '<div class="warrior-card" onclick="selectWarrior(\''+beer.id+'\')" style="--beer-color:'+beer.color+';animation-delay:'+(i*0.06)+'s">'+
    '<div class="warrior-emoji">'+beer.emoji+'</div>'+
    '<div class="warrior-name">'+beer.name+'</div>'+
    '<div class="warrior-tagline">'+beer.tagline+'</div>'+
    '</div>'
  ).join('');
}

function showWarriorSelect(){
  const overlay=document.getElementById('warriorOverlay');
  overlay.classList.remove('closing');
  overlay.classList.add('visible');
  playArcadeSelect();
}

function hideWarriorSelect(){
  const overlay=document.getElementById('warriorOverlay');
  overlay.classList.add('closing');
  setTimeout(()=>{overlay.classList.remove('visible','closing');},500);
}

function selectWarrior(beerId){
  const beer=BEER_OPTIONS.find(b=>b.id===beerId);
  if(!beer) return;
  selectedBeer=beer;
  playArcadeConfirm();

  const cards=document.querySelectorAll('.warrior-card');
  cards.forEach(c=>{
    if(c.onclick.toString().includes(beerId)) c.classList.add('selected');
    else c.style.opacity='0.3';
  });

  setTimeout(()=>{
    const flash=document.getElementById('warriorFlash');
    flash.classList.add('visible');
    setTimeout(()=>{
      flash.classList.remove('visible');
      hideWarriorSelect();
      cards.forEach(c=>{c.classList.remove('selected');c.style.opacity='';});
      startSession();
    },700);
  },400);
}

// ========== STATUS ==========
function updateStatus(){
  const badge=document.getElementById('statusBadge');
  const hrs=getElapsedHours();
  const bph=hrs>0?beers/hrs:(beers>0?beers*60:0);
  let text,color;
  if(beers===0&&!sessionActive){text='Sober & Curious';color='#ffffff';}
  else if(bph<1){text='Sober & Curious';color='#ffffff';}
  else if(bph<2){text='Feeling Patriotic';color='#ffd700';}
  else if(bph<4){text='Full Send';color='#ff8c00';}
  else if(bph<6){text='Send Help';color='#ff0000';}
  else{text='CALL 911';color='#ff0000';}
  badge.textContent=text;badge.style.color=color;badge.style.borderColor=color;

  if(text==='CALL 911'){
    // Flash for 1 second then stop (not continuous)
    if(!document.body.classList.contains('call911')){
      badge.style.animation='status-flash 0.5s ease 2';
      document.body.classList.add('call911');
      if(call911Timeout) clearTimeout(call911Timeout);
      call911Timeout=setTimeout(()=>{
        document.body.classList.remove('call911');
        badge.style.animation='none';
        call911Timeout=null;
      },1000);
    }
  }else{
    badge.style.animation='none';
    if(call911Timeout){clearTimeout(call911Timeout);call911Timeout=null;}
    document.body.classList.remove('call911');
  }
}

// ========== TOAST ==========
function showToast(msg){
  const container=document.getElementById('toastContainer');
  const toast=document.createElement('div');
  toast.className='toast';toast.textContent=msg;
  container.appendChild(toast);
  setTimeout(()=>{toast.classList.add('removing');setTimeout(()=>toast.remove(),300);},3000);
}

// ========== ACHIEVEMENTS ==========
function getUnlockedAchievements(){
  try{return JSON.parse(localStorage.getItem('blakeAchievements'))||[];}catch{return[];}
}
function saveAchievement(id){
  const unlocked=getUnlockedAchievements();
  if(!unlocked.includes(id)){unlocked.push(id);localStorage.setItem('blakeAchievements',JSON.stringify(unlocked));}
}
function checkAchievements(){
  const unlocked=getUnlockedAchievements();
  const hrs=getElapsedHours();const bph=hrs>0?beers/hrs:0;const record=getRecord();
  const checks=[
    {id:'first_blood',cond:beers>=1},{id:'founding_father',cond:beers>=5},
    {id:'full_patriot',cond:beers>=10},{id:'rabbit_hole',cond:hrs>=2},
    {id:'no_life',cond:hrs>=4},{id:'efficiency',cond:bph>=5&&hrs>=0.05},
    {id:'personal_record',cond:beers>record&&beers>0&&record>0},
  ];
  checks.forEach(ch=>{
    if(ch.cond&&!unlocked.includes(ch.id)){
      const ach=ACHIEVEMENTS.find(a=>a.id===ch.id);
      saveAchievement(ch.id);showToast(ach.icon+' '+ach.name+' unlocked!');
      playFanfare();spawnConfetti();
    }
  });
  renderAchievements();
}
function renderAchievements(){
  const unlocked=getUnlockedAchievements();
  document.getElementById('achievementsList').innerHTML=ACHIEVEMENTS.map(a=>
    '<span class="ach-badge '+(unlocked.includes(a.id)?'unlocked':'')+'" title="'+a.desc+'">'+a.icon+' '+a.name+'</span>'
  ).join('');
}

// ========== DATA ==========
function getSessions(){try{return JSON.parse(localStorage.getItem('blakeSessions'))||[];}catch{return[];}}
function saveSessions(s){localStorage.setItem('blakeSessions',JSON.stringify(s));}
function getRecord(){try{return parseInt(localStorage.getItem('blakeRecord'))||0;}catch{return 0;}}
function saveRecord(r){localStorage.setItem('blakeRecord',JSON.stringify(r));}
function getElapsedMs(){if(!sessionStart)return 0;return Date.now()-sessionStart;}
function getElapsedHours(){return getElapsedMs()/3600000;}
function formatTime(ms){
  const s=Math.floor(ms/1000);
  return String(Math.floor(s/3600)).padStart(2,'0')+':'+String(Math.floor((s%3600)/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');
}

// ========== SESSION ==========
function toggleSession(){
  if(!sessionActive){showWarriorSelect();}
  else{endSession();}
}

function startSession(){
  sessionActive=true;sessionStart=Date.now();beers=0;shakeIntensity=3;
  document.getElementById('beerCount').textContent='0';
  document.getElementById('timerBtn').textContent='End Session';
  document.getElementById('timerBtn').classList.add('stop');
  document.getElementById('minusBtn').disabled=true;
  if(selectedBeer){
    document.getElementById('selectedBeerDisplay').innerHTML=
      'Drinking: <span>'+selectedBeer.emoji+' '+selectedBeer.name+'</span>';
  }
  // Auto-open session metrics tab
  const sessTab=document.getElementById('sessionTab');
  if(!sessTab.classList.contains('open')) sessTab.classList.add('open');

  updateDrunkEffects();updateSessionMetrics();playAirHorn();
  timerInterval=setInterval(()=>{
    document.getElementById('timerDisplay').textContent=formatTime(getElapsedMs());
    updateSessionMetrics();
    checkAchievements();
  },1000);
  tickInterval=setInterval(()=>{if(sessionActive)playTick();},1000);
  statusInterval=setInterval(updateStatus,30000);
  updateStatus();
}

function endSession(){
  if(!sessionActive)return;
  sessionActive=false;
  const elapsed=getElapsedMs();const hrs=elapsed/3600000;
  const bph=hrs>0?(beers/hrs).toFixed(2):'0.00';
  clearInterval(timerInterval);clearInterval(tickInterval);clearInterval(statusInterval);
  timerInterval=null;tickInterval=null;statusInterval=null;
  if(shakeTimer){cancelAnimationFrame(shakeTimer);shakeTimer=null;}
  playSadTrombone();
  const session={
    date:new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}),
    duration:formatTime(elapsed),durationMs:elapsed,beers:beers,bph:parseFloat(bph),
    beerType:selectedBeer?selectedBeer.name:null,
  };
  const sessions=getSessions();sessions.unshift(session);saveSessions(sessions);
  if(beers>getRecord())saveRecord(beers);
  document.getElementById('timerBtn').textContent='Start Session';
  document.getElementById('timerBtn').classList.remove('stop');
  document.getElementById('app').style.transform='';
  document.getElementById('timerDisplay').style.filter='none';
  document.body.style.backgroundColor='';
  document.body.classList.remove('call911');
  if(call911Timeout){clearTimeout(call911Timeout);call911Timeout=null;}
  document.getElementById('selectedBeerDisplay').innerHTML='';
  selectedBeer=null;shakeIntensity=3;
  updateSessionMetrics();
  updateStats();renderHistory();updateStatus();
}

// ========== BEER ==========
function changeBeer(delta){
  if(!sessionActive)return;
  beers=Math.max(0,beers+delta);
  const countEl=document.getElementById('beerCount');
  countEl.textContent=beers;
  document.getElementById('minusBtn').disabled=beers<=0;

  if(delta>0){
    // Guitar riff + flag/eagle animation on every beer
    playGuitarRiff();
    triggerFlagEagle();
    spawnBeerRain();
    screenShake();
    // pop animation on count
    countEl.classList.remove('pop');void countEl.offsetWidth;countEl.classList.add('pop');
    // pulse the + button
    const plusBtn=document.getElementById('plusBtn');
    plusBtn.classList.remove('plus-pulse');void plusBtn.offsetWidth;plusBtn.classList.add('plus-pulse');
    // milestones
    if(beers===5){playUSAChant();showToast('\u{1F1FA}\u{1F1F8} USA! USA! USA! \u{1F1FA}\u{1F1F8}');}
    if(beers===10){playBigAirHorn();screenFlash();showToast('\u{1F4A5} 10 BEERS. ABSOLUTE UNIT. \u{1F4A5}');}
  }else{
    playSadBell();
  }
  updateDrunkEffects();updateStatus();updateSessionMetrics();checkAchievements();
}

// ========== STATS ==========
function updateStats(){
  const sessions=getSessions();let totalMs=0,totalBeers=0;
  const beerCounts={};
  sessions.forEach(s=>{
    totalMs+=s.durationMs||0;totalBeers+=s.beers||0;
    if(s.beerType){beerCounts[s.beerType]=(beerCounts[s.beerType]||0)+1;}
  });
  const totalHrs=totalMs/3600000;
  document.getElementById('ltSessions').textContent=sessions.length;
  document.getElementById('ltHours').textContent=totalHrs.toFixed(1);
  document.getElementById('ltBeers').textContent=totalBeers;
  document.getElementById('ltAvg').textContent=totalHrs>0?(totalBeers/totalHrs).toFixed(1):'0.0';
  document.getElementById('ltRecord').textContent=getRecord();

  // Find favorite beer
  let favBeer='--';
  let maxCount=0;
  Object.entries(beerCounts).forEach(([name,count])=>{
    if(count>maxCount){maxCount=count;favBeer=name;}
  });
  document.getElementById('ltFavBeer').textContent=favBeer;
}

// ========== HISTORY ==========
function renderHistory(){
  const sessions=getSessions();
  const container=document.getElementById('historyList');
  if(sessions.length===0){container.innerHTML='<div class="empty-state">No sessions yet. Start one above.</div>';return;}
  container.innerHTML=sessions.map(s=>{
    const scoreLabel=s.bph<2?'Casual':s.bph<4?'Committed':s.bph<6?'Dangerous':'LEGENDARY';
    const beerLine=s.beerType?'<div class="hc-beer-type">'+s.beerType+'</div>':'';
    return '<div class="history-card">'+
      '<div class="hc-date">'+s.date+'</div>'+beerLine+
      '<div><div class="hc-val">'+s.duration+'</div><div class="hc-lbl">Duration</div></div>'+
      '<div><div class="hc-val">'+s.beers+' \u{1F37A}</div><div class="hc-lbl">Beers</div></div>'+
      '<div><div class="hc-val hc-score">'+s.bph.toFixed(1)+'/hr</div><div class="hc-lbl">Rate</div></div>'+
      '<div><div class="hc-val hc-score">'+scoreLabel+'</div><div class="hc-lbl">Verdict</div></div>'+
      '</div>';
  }).join('');
}

// ========== INIT ==========
function init(){
  buildFlagStars();
  renderWarriorGrid();updateStats();renderHistory();renderAchievements();updateStatus();updateSessionMetrics();
}
init();

if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}
</script>
</body>
</html>
